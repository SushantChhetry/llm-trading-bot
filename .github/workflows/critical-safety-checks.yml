name: Critical Safety Checks

on:
  push:
    branches: [main]
    paths:
      - 'deepseek-experiment/src/trading_engine.py'
      - 'deepseek-experiment/src/risk_client.py'
      - 'deepseek-experiment/services/risk_service.py'
      - 'deepseek-experiment/src/startup_validator.py'
      - 'deepseek-experiment/tests/test_kill_switch.py'
      - '.github/workflows/critical-safety-checks.yml'
  pull_request:
    branches: [main]
    paths:
      - 'deepseek-experiment/src/trading_engine.py'
      - 'deepseek-experiment/src/risk_client.py'
      - 'deepseek-experiment/services/risk_service.py'
      - 'deepseek-experiment/src/startup_validator.py'
  workflow_dispatch:  # Manual trigger for testing

# Allow skipping with [skip ci] or [skip safety]
concurrency:
  group: critical-safety-checks
  cancel-in-progress: false

jobs:
  critical-safety:
    name: Critical Safety Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Fast timeout to avoid blocking

    defaults:
      run:
        working-directory: ./deepseek-experiment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Single version for speed
          cache: 'pip'
          cache-dependency-path: './deepseek-experiment/requirements.txt'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('deepseek-experiment/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start Risk Service
        run: |
          python -m services.risk_service &
          sleep 2
          timeout 5 bash -c 'until curl -f http://localhost:8003/health; do sleep 0.5; done' || exit 1
        env:
          PORT: 8003
          RISK_SERVICE_PORT: 8003

      - name: Test 1 - Risk Service Health
        timeout-minutes: 1
        run: |
          python -c "
          import requests
          r = requests.get('http://localhost:8003/health', timeout=2)
          assert r.status_code == 200, f'Health check failed: {r.status_code}'
          print('âœ… Risk service health check passed')
          "

      - name: Test 2 - Kill Switch Blocks Trades
        timeout-minutes: 1
        run: |
          python -c "
          import requests
          import time
          
          # Activate kill switch
          r = requests.post('http://localhost:8003/risk/kill_switch',
              json={'action': 'activate', 'reason': 'CI test'}, timeout=2)
          assert r.status_code == 200, 'Failed to activate kill switch'
          
          # Try to validate order (should be rejected)
          r = requests.post('http://localhost:8003/risk/validate_order',
              json={
                  'strategy_id': 'test',
                  'symbol': 'BTC/USDT',
                  'side': 'buy',
                  'quantity': 0.1,
                  'price': 50000.0,
                  'leverage': 1.0,
                  'current_nav': 10000.0,
                  'position_value': 5000.0
              }, timeout=2)
          
          data = r.json()
          assert not data.get('approved', True), 'Kill switch did not block trade'
          assert data.get('status') == 'kill_switch', 'Wrong status'
          print('âœ… Kill switch correctly blocks trades')
          
          # Deactivate
          requests.post('http://localhost:8003/risk/kill_switch',
              json={'action': 'deactivate'}, timeout=2)
          "

      - name: Test 3 - Risk Validation Integration
        timeout-minutes: 1
        env:
          PYTHONPATH: ${{ github.workspace }}/deepseek-experiment
        run: |
          python -c "
          import sys
          import os
          sys.path.insert(0, os.getcwd())
          from src.risk_client import RiskClient
          from config import config
          
          config.RISK_SERVICE_FAIL_CLOSED = True
          client = RiskClient(risk_service_url='http://localhost:8003')
          
          result = client.validate_order(
              strategy_id='test',
              symbol='BTC/USDT',
              side='buy',
              quantity=0.1,
              price=50000.0,
              leverage=1.0,
              current_nav=10000.0,
              position_value=5000.0
          )
          
          assert hasattr(result, 'approved'), 'Invalid result object'
          assert result.status in ['approved', 'rejected', 'kill_switch'], f'Invalid status: {result.status}'
          print('âœ… Risk validation integration working')
          "

      - name: Test 4 - Fail-Closed Behavior
        timeout-minutes: 1
        env:
          PYTHONPATH: ${{ github.workspace }}/deepseek-experiment
        run: |
          python -c "
          import sys
          import os
          sys.path.insert(0, os.getcwd())
          from src.risk_client import RiskClient
          from config import config
          
          # Test fail-closed when service is unreachable
          config.RISK_SERVICE_FAIL_CLOSED = True
          client = RiskClient(risk_service_url='http://localhost:9999')  # Non-existent
          
          result = client.validate_order(
              strategy_id='test',
              symbol='BTC/USDT',
              side='buy',
              quantity=0.1,
              price=50000.0,
              leverage=1.0,
              current_nav=10000.0,
              position_value=5000.0
          )
          
          assert not result.approved, 'Fail-closed not working - trade approved when service down'
          assert 'fail-closed' in result.reason.lower(), 'Missing fail-closed reason'
          print('âœ… Fail-closed behavior working')
          "

      - name: Test 5 - Daily Loss Tracking Exists
        timeout-minutes: 1
        env:
          PYTHONPATH: ${{ github.workspace }}/deepseek-experiment
        run: |
          python -c "
          import sys
          import os
          sys.path.insert(0, os.getcwd())
          from src.trading_engine import TradingEngine
          
          engine = TradingEngine(initial_balance=10000.0)
          
          # Verify methods exist
          assert hasattr(engine, '_calculate_daily_loss_pct'), 'Missing _calculate_daily_loss_pct'
          assert hasattr(engine, '_check_and_reset_daily_tracking'), 'Missing _check_and_reset_daily_tracking'
          
          # Test calculation
          engine.daily_start_nav = 10000.0
          loss_pct = engine._calculate_daily_loss_pct(9800.0)  # 2% loss
          assert abs(loss_pct - 0.02) < 0.001, f'Expected 0.02, got {loss_pct}'
          print('âœ… Daily loss tracking working')
          "

      - name: Test Summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Critical Safety Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tests Run:**" >> $GITHUB_STEP_SUMMARY
          echo "- Risk Service Health" >> $GITHUB_STEP_SUMMARY
          echo "- Kill Switch Functionality" >> $GITHUB_STEP_SUMMARY
          echo "- Risk Validation Integration" >> $GITHUB_STEP_SUMMARY
          echo "- Fail-Closed Behavior" >> $GITHUB_STEP_SUMMARY
          echo "- Daily Loss Tracking" >> $GITHUB_STEP_SUMMARY

